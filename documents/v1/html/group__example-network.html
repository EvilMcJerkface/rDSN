<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>rDSN: Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">rDSN
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example<div class="ingroups"><a class="el" href="group__ext.html">Extensions and Environment Integration</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Plugin A New Network Implementation.  
<a href="#details">More...</a></p>
<p>Plugin A New Network Implementation. </p>
<p>rDSN is designed to be extensible, see <a href="https://github.com/Microsoft/rDSN/wiki/Tool-API:-Component-Providers,-Join-Points,-and-State-Extensions">here</a> for details. This tutorial illustrates how we can plugin a new network implementation for rDSN, due to higher performance or personal favor. Note the new plugin will also be able to contribute to other rDSN developers once <a href="https://github.com/Microsoft/rDSN/wiki/Contribute">contributing</a> to rDSN.</p>
<h3>Preliminaries</h3>
<p>rDSN supports many networks running concurrently at the same time by allowing multiple ports specified and configured differently. For each network, it configures the following dimensions of properties:</p>
<p>network channel</p>
<div class="fragment"><div class="line">{C++}</div><div class="line">DEFINE_CUSTOMIZED_ID_TYPE(rpc_channel)</div><div class="line">DEFINE_CUSTOMIZED_ID(rpc_channel, RPC_CHANNEL_TCP)</div><div class="line">DEFINE_CUSTOMIZED_ID(rpc_channel, RPC_CHANNEL_UDP)</div></div><!-- fragment --><p>A network can usually support one type of channel, e.g. tcp, udp, http, websocket, or rdma. For certain networks, e.g., the simulation network, it can easily support all of them.</p>
<p>network message header format</p>
<div class="fragment"><div class="line">{C++}</div><div class="line">DEFINE_CUSTOMIZED_ID_TYPE(network_header_format);</div><div class="line">DEFINE_CUSTOMIZED_ID(network_header_format, NET_HDR_DSN);</div><div class="line">DEFINE_CUSTOMIZED_ID(network_header_format, NET_HDR_THRIFT);</div></div><!-- fragment --><p>A network can usually support all types of header format, by adopting different <a href="https://github.com/Microsoft/rDSN/blob/master/include/dsn/internal/message_parser.h#L64">message_parser</a>s. A message parser prepares binary blobs from <a href="https://github.com/Microsoft/rDSN/blob/master/include/dsn/internal/rpc_message.h#L85">rpc_message</a> for sending, and composes rpc_message from incoming binary blobs from network channels.</p>
<p>network message body encoding</p>
<p>The encoding of network message body is handled by upper layer (syntactic sugar library layer, i.e., dsn.core now), so it is not a concern of network implementation so far.</p>
<p>A network instance takes charge of two things given a configured network channel and a listening port:</p>
<p>send the message to a designated address</p>
<p>for client calls with a not-null <b>callback</b> specified, a network should invoke the callback either on timeout or when the response message from remote peer is received. To assist this feature, rDSN provides a class called <a href="https://github.com/Microsoft/rDSN/blob/master/include/dsn/internal/network.h#L117">rpc_client_matcher</a>, where it provides two methods to be called on message send and receive, and it handles timeout internally so developers don't bother.</p>
<h3>STEP 1. define your network</h3>
<p>Developers choose what kind of network channel to support by this network (e.g., RPC_CHANNEL_TCP), and when necessary, define new network channel by</p>
<div class="fragment"><div class="line">{C++}</div><div class="line">DEFINE_CUSTOMIZED_ID(rpc_channel, RPC_CHANNEL_HTTP)</div></div><!-- fragment --><p>The base interface for network is <a href="https://github.com/Microsoft/rDSN/blob/master/include/dsn/internal/network.h#L41">network</a>. When it is started, it is give the configured network channel, as well as the listen port. For ease of development for connection oriented network, rDSN further provides <a href="https://github.com/Microsoft/rDSN/blob/master/include/dsn/internal/network.h#L153">connection_oriented_network</a>, where it handles management of <a href="https://github.com/Microsoft/rDSN/blob/master/include/dsn/internal/network.h#L187">rpc_client_session</a> and <a href="https://github.com/Microsoft/rDSN/blob/master/include/dsn/internal/network.h#L210">rpc_server_session</a>.</p>
<p>By selecting and implementing the appropriate base interface, developers implement their own network. Examples are <a href="https://github.com/Microsoft/rDSN/blob/master/src/tools/common/network.sim.h">here</a> and <a href="https://github.com/Microsoft/rDSN/blob/master/src/tools/common/net_provider.h">here</a>.</p>
<h3>STEP 2. register your network</h3>
<p>After implementation, developers register the network into rDSN.</p>
<div class="fragment"><div class="line">{C++}</div><div class="line">register_component_provider&lt;asio_network_provider&gt;(<span class="stringliteral">&quot;dsn::tools::asio_network_provider&quot;</span>);</div><div class="line">register_component_provider&lt;sim_network_provider&gt;(<span class="stringliteral">&quot;dsn::tools::sim_network_provider&quot;</span>);</div></div><!-- fragment --><h3>STEP 3. use your network</h3>
<p>Specify the network provider in your configuration file as follows; note rDSN supports multiple networks running concurrently with different configurations. For each service app:</p>
<div class="fragment"><div class="line">[apps.default]</div><div class="line">network.client.RPC_CHANNEL_TCP = dsn::tools::sim_network_provider, 65536</div><div class="line">network.client.RPC_CHANNEL_UDP = dsn::tools::sim_network_provider, 65536</div><div class="line">network.server.0.RPC_CHANNEL_TCP = NET_HDR_DSN, dsn::tools::sim_network_provider, 65536</div><div class="line">network.server.0.RPC_CHANNEL_UDP = NET_HDR_DSN, dsn::tools::sim_network_provider, 65536</div><div class="line"></div><div class="line">[apps.replica]</div><div class="line">ports = 30601,30602</div><div class="line">network.server.30601.RPC_CHANNEL_TCP = NET_HDR_DSN, dsn::tools::sim_network_provider, 65536</div><div class="line">network.server.30602.RPC_CHANNEL_TCP = NET_HDR_THRIFT, dsn::tools::asio_network_provider, 65536</div></div><!-- fragment --><p> rDSN will create a whole set of network servers and clients using the above settings accordingly. For each type of RPC (client) calls, you can further specify the channel and message header format for them.</p>
<div class="fragment"><div class="line">[task.default]</div><div class="line">rpc_call_channel = RPC_CHANNEL_TCP</div><div class="line">rpc_call_header_format = NET_HDR_DSN</div><div class="line"></div><div class="line">[task.RPC_FD_BEACON]</div><div class="line">rpc_call_channel = RPC_CHANNEL_UDP</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
