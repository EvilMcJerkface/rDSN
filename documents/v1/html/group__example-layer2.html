<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>rDSN: Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">rDSN
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example<div class="ingroups"><a class="el" href="group__dev.html">A Layered Stack for Distributed System Development</a> &raquo; <a class="el" href="group__dev-layer2.html">EON: Make Applications Scalable and Reliable Automatically (layer 2)</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Build a scalable and reliable counter service with built-in replication support.  
<a href="#details">More...</a></p>
<p>Build a scalable and reliable counter service with built-in replication support. </p>
<p>We will continue using the <a href="https://github.com/Microsoft/rDSN/wiki/Tutorial:-Build-A-Single-Node-Counter-Service">counter</a> example and turn it from a single node service to a partitioned and replicated service for scalability and reliability. A more serious case is <a href="https://github.com/imzhenyu/rocksdb">RocksDB</a>.</p>
<p>Many people asked about what kinds of replication protocol we're using. Currently, our default provider largely follows <a href="http://research.microsoft.com/apps/pubs/default.aspx?id=66814">PacificA</a>. We may have other protocols as framework providers in layer 2 in the future.</p>
<h3>STEP 1. Code generation</h3>
<p>Code generation is very similar to what we do for the single-node service development before, except for the following two minor additions.</p>
<h5>STEP 1.1 Annotate the interface, tell rDSN which methods need to be replicated.</h5>
<p>Methods for a service usually contain both read-only and write methods. Replication is necessary for only those write methods. Developers therefore use a separated annotation file (in order to support both Thrift and Google Protoc, as well as further ones) to mark them. Following is the example as in <a href="https://github.com/Microsoft/rDSN/blob/master/tutorial/counter.thrift.annotations">here</a>.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;; annotation format</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;;[type.name[[.subname]...]]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;;key = vlaue</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;[service.counter]</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;stateful = true ; counter is a stateful service</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;[function.counter.add]</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;write = true  ; counter.add is a write function</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;[function.counter.read]</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;write = false</div></div><!-- fragment --> <h5>STEP 1.2 Generate the code with both the IDL definition file and the annotation file as inputs.</h5>
<p>This is exactly the same compared to <a href="https://github.com/Microsoft/rDSN/wiki/Tutorial:-Build-A-Single-Node-Counter-Service#step-12">step 1.2 for single-node development</a>, except that we add the <b>replication</b> argument for the code generation tool.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;~/projects/rdsn/tutorial$ dsn.cg.sh counter.thrift cpp counter.rep replication</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;generate &#39;counter.rep/CMakeLists.txt&#39; successfully!</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;generate &#39;counter.rep/counter.app.example.h&#39; successfully!</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;generate &#39;counter.rep/counter.client.h&#39; successfully!</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;generate &#39;counter.rep/counter.code.definition.h&#39; successfully!</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;generate &#39;counter.rep/config.ini&#39; successfully!</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;generate &#39;counter.rep/counter.main.cpp&#39; successfully!</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;generate &#39;counter.rep/counter.server.h&#39; successfully!</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;generate &#39;counter.rep/counter.types.h&#39; successfully!</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;...</div></div><!-- fragment --> <h3>STEP 2. Implement application logic</h3>
<p>This remains exactly the <a href="https://github.com/Microsoft/rDSN/wiki/Tutorial:-Build-A-Single-Node-Counter-Service#step-2-implement-application-logic">same</a>.</p>
<h3>STEP 3. Implement application specific replication logic</h3>
<p>This is the extra step we need for replication, mostly about writing helper functions for replication so that it can work smoothly and efficiently for the given application. Description about the helper functions can be found <a href="https://github.com/Microsoft/rDSN/blob/master/include/dsn/dist/replication/replication_app_base.h#L50">here</a>, and the implementation for our counter service example is <a href="https://github.com/Microsoft/rDSN/tree/master/tutorial/counter.replication">here</a>.</p>
<h3>STEP 4. Register the implementation, compile and run</h3>
<p>We register the new service implementation to rDSN in main (done by code generation), and compile should be ok.</p>
<div class="fragment"><div class="line">{C++}</div><div class="line"><span class="keyword">register</span> replication application provider</div><div class="line">dsn::replication::register_replica_provider&lt; ::dsn::example::counter_service_impl&gt;(<span class="stringliteral">&quot;counter&quot;</span>);</div></div><!-- fragment --><p>Note on windows, we still need to specify where are the boost header files and libraries, etc.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;c:\Projects\rDSN\tutorial\counter.rep\build&gt;cmake .. -G &quot;Visual Studio 12 2013&quot; -DBOOST_INCLUDEDIR=c:\local\boost_1_57_0 -DBOOST_LIBRARYDIR=c:\local\boost_1_57_0\lib32-msvc-12.0 </div></div><!-- fragment --><p>Before running the system, we need to configure the meta server and the replica servers.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[apps.client]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;name = client</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;type = client</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;arguments = counter.instance0</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;run = true</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;count = 2 </div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;[replication.app]</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;app_name = counter.instance0 </div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;app_type = counter </div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;partition_count = 1</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;max_replica_count = 3</div></div><!-- fragment --><p>Then go to the directory where 'counter.exe' is generated and run; make sure 'config.ini' is also copied there.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;00:00:35.045(35045) replica3.replication0.0000000003c93bc8: 1.0 @ localhost:34803: mutation 14.39 ack_prepare_message</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;00:00:35.057(35057) replica2.replication0.0000000003c93ec8: 1.0 @ localhost:34802: mutation 14.39 on_append_log_completed, err = 0</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;00:00:35.057(35057) replica2.replication0.0000000003c93ec8: 1.0 @ localhost:34802: mutation 14.39 ack_prepare_message</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;00:00:35.078(35078) replica1.replication0.0000000003c932c8: 1.0 @ localhost:34801: mutation 14.39 on_prepare_reply from localhost:34803</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;00:00:35.091(35091) replica1.replication0.0000000003c93088: 1.0 @ localhost:34801: mutation 14.39 on_prepare_reply from localhost:34802</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;00:00:35.091(35091) replica1.replication0.0000000003c93088: TwoPhaseCommit, 1.0 @ localhost:34801: mutation 14.39 committed, err = 0</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;call RPC_COUNTER_COUNTER_ADD end, return ERR_SUCCESS</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;call RPC_COUNTER_COUNTER_READ end, return ERR_SUCCESS</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;00:00:35.624(35624) replica1.replication0.0000000003c8c1a0: 1.0 @ localhost:34801: mutation 14.40 init_prepare</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;00:00:35.624(35624) replica1.replication0.0000000003c8c1a0: 1.0 @ localhost:34801: mutation 14.40 send_prepare_message to localhost:34803 as PS_SECONDARY</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;00:00:35.624(35624) replica1.replication0.0000000003c8c1a0: 1.0 @ localhost:34801: mutation 14.40 send_prepare_message to localhost:34802 as PS_SECONDARY</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;00:00:35.676(35676) replica3.replication0.0000000003c93fa8: 1.0 @ localhost:34803: mutation 14.40 on_prepare</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;00:00:35.676(35676) replica3.replication0.0000000003c93fa8: TwoPhaseCommit, 1.0 @ localhost:34803: mutation 14.39 committed, err = 0</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;00:00:35.705(35705) replica2.replication0.0000000000eae958: 1.0 @ localhost:34802: mutation 14.40 on_prepare</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;00:00:35.705(35705) replica2.replication0.0000000000eae958: TwoPhaseCommit, 1.0 @ localhost:34802: mutation 14.39 committed, err = 0</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;00:00:35.724(35724) replica1.replication0.0000000003c93988: 1.0 @ localhost:34801: mutation 14.40 on_append_log_completed, err = 0</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;00:00:35.776(35776) replica3.replication0.0000000003c93d48: 1.0 @ localhost:34803: mutation 14.40 on_append_log_completed, err = 0</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;00:00:35.776(35776) replica3.replication0.0000000003c93d48: 1.0 @ localhost:34803: mutation 14.40 ack_prepare_message</div></div><!-- fragment --><h3>STEP 5. Use test/vtest to batch test the program</h3>
<p>It's natural that we sometimes want to test codes by running multiple programs simultaneously. We provide a simple script for occasions like that. In the "tutorial/counter.test/" folder we prepared an example. "test" is for simulator mode and "vtest" is for nativerun mode. They're basically the same thing with different config files.</p>
<p>To use it, copy the .cmd and .ini files into the folder containing .exe file. Remember to set the iteration times and program name in the .cmd. And configure the .ini file if necessary. Then run the .cmd files.</p>
<p>Normally you should see multiple programs bumping out running at the same time. </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
